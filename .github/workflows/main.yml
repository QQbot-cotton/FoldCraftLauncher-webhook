name: Sync Releases from FoldCraftLauncher

on:
  schedule:
    - cron: '0 * * * *'   # 每小时检查一次
  workflow_dispatch:

jobs:
  sync_release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v2

    # 获取原仓库 release 信息
    - name: Get latest release info
      run: |
        curl --silent "https://api.github.com/repos/FCL-Team/FoldCraftLauncher/releases/latest" > upstream.json
        jq -r .tag_name upstream.json > release.txt
        jq -r '.assets[].browser_download_url' upstream.json > assets_urls.txt

    # 获取当前 fork 最新 release
    - name: Get latest fork release
      run: |
        curl --silent "https://api.github.com/repos/${{ github.repository }}/releases/latest" | jq -r .tag_name > current_release.txt
    
    # 下载 & 提交
    - name: Download and commit all assets
      run: |
        original_release=$(cat release.txt)
        current_release=$(cat current_release.txt || echo "")
        if [ "$original_release" != "$current_release" ]; then
          echo "New release detected: $original_release"

          # 下载所有 APK
          mkdir -p assets
          while read url; do
            filename=$(basename "$url")
            echo "Downloading $filename"
            curl -L "$url" -o "assets/$filename"
          done < assets_urls.txt

          # 配置 Git
          git config --global user.email "${{ secrets.GIT_EMAIL }}"
          git config --global user.name "${{ secrets.GIT_NAME }}"

          # 将下载的文件添加到 Git
          git add -f assets/*
          git commit -m "Sync FoldCraftLauncher release $original_release"
          git push
        else
          echo "No new release ($original_release)"
        fi
